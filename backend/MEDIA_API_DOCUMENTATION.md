# Comprehensive Media Management API Documentation\n\nThis document describes the complete media management API that integrates with the Media model for handling images and videos in the multi-screen advertisement platform.\n\n## Overview\n\nThe Media Management API provides comprehensive endpoints for:\n- ✅ File upload with metadata handling\n- ✅ Advanced media retrieval with filtering, pagination, and search\n- ✅ Metadata updates for existing media\n- ✅ Secure file deletion with cleanup\n- ✅ Time-limited download URL generation\n- ✅ User media statistics and analytics\n- ✅ Video thumbnail generation\n\n## Base URL\n\n```\nPOST   /api/media/upload           - Upload media with metadata\nGET    /api/media                  - Get user's media (with filters)\nPUT    /api/media/:id              - Update media metadata\nDELETE /api/media/:id              - Delete media\nGET    /api/media/:id/download     - Generate secure download URL\nGET    /api/media/stats            - Get user media statistics\nPOST   /api/media/:id/thumbnail    - Generate video thumbnail\n```\n\n## Authentication\n\nAll endpoints require JWT authentication:\n```\nHeaders: {\n  \"Authorization\": \"Bearer <jwt_token>\"\n}\n```\n\n## Rate Limiting\n\n- Upload endpoints: 50 requests per 15 minutes\n- Other endpoints: 100 requests per 15 minutes\n\n## File Constraints\n\n- **Images**: Max 10MB, formats: jpg, jpeg, png, gif, webp, bmp, svg\n- **Videos**: Max 50MB, formats: mp4, avi, mov, wmv, flv, webm, mkv\n- **Total files per upload**: 1 file\n- **Max files per user**: 1000 (configurable)\n\n---\n\n## 1. Upload Media\n\n**Endpoint:** `POST /api/media/upload`\n\n**Description:** Upload a single media file with comprehensive metadata handling.\n\n### Request\n\n**Content-Type:** `multipart/form-data`\n\n**Form Fields:**\n- `file` (required): Media file (image or video)\n- `duration` (optional): Display duration for images (1-300 seconds)\n- `tags` (optional): Comma-separated tags\n- `description` (optional): File description (max 500 characters)\n\n### Example Request\n\n```javascript\nconst form = new FormData();\nform.append('file', fileBuffer, {\n  filename: 'advertisement.jpg',\n  contentType: 'image/jpeg'\n});\nform.append('duration', '15');\nform.append('tags', 'advertisement,outdoor,summer');\nform.append('description', 'Summer outdoor advertisement campaign');\n\nconst response = await axios.post('/api/media/upload', form, {\n  headers: {\n    ...form.getHeaders(),\n    'Authorization': 'Bearer <token>'\n  }\n});\n```\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Media uploaded successfully\",\n  \"data\": {\n    \"_id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n    \"originalName\": \"advertisement.jpg\",\n    \"filename\": \"64f8a1b2c3d4e5f6a7b8c9d0_1694123456789_a1b2c3d4_advertisement.jpg\",\n    \"cloudinaryId\": \"advertisements/64f8a1b2c3d4e5f6a7b8c9d0/images/1694123456789_advertisement\",\n    \"url\": \"http://res.cloudinary.com/...\",\n    \"secureUrl\": \"https://res.cloudinary.com/...\",\n    \"type\": \"image\",\n    \"format\": \"jpg\",\n    \"width\": 1920,\n    \"height\": 1080,\n    \"fileSize\": 245760,\n    \"duration\": 15,\n    \"tags\": [\"advertisement\", \"outdoor\", \"summer\"],\n    \"description\": \"Summer outdoor advertisement campaign\",\n    \"owner\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n    \"usageCount\": 0,\n    \"isActive\": true,\n    \"createdAt\": \"2023-09-08T10:30:45.123Z\",\n    \"updatedAt\": \"2023-09-08T10:30:45.123Z\",\n    \"aspectRatio\": \"1.78\",\n    \"isLandscape\": true,\n    \"formattedFileSize\": \"240.00 KB\",\n    \"formattedDuration\": \"15s\"\n  }\n}\n```\n\n---\n\n## 2. Get Media with Advanced Features\n\n**Endpoint:** `GET /api/media`\n\n**Description:** Retrieve user's media with advanced filtering, pagination, search, and sorting.\n\n### Query Parameters\n\n- `page` (number, default: 1): Page number\n- `limit` (number, default: 20, max: 100): Items per page\n- `type` (string): Filter by type (\"image\" or \"video\")\n- `search` (string): Search in name, description, and tags\n- `sort` (string, default: \"date\"): Sort by (\"date\", \"name\", \"size\", \"usage\")\n- `order` (string, default: \"desc\"): Sort order (\"asc\" or \"desc\")\n- `tags` (string): Filter by comma-separated tags\n\n### Example Request\n\n```javascript\nconst response = await axios.get('/api/media?type=image&search=advertisement&sort=size&order=desc&page=1&limit=10', {\n  headers: { 'Authorization': 'Bearer <token>' }\n});\n```\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Media retrieved successfully\",\n  \"data\": {\n    \"media\": [\n      {\n        \"_id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n        \"originalName\": \"advertisement.jpg\",\n        \"type\": \"image\",\n        \"fileSize\": 245760,\n        \"duration\": 15,\n        \"tags\": [\"advertisement\", \"outdoor\"],\n        \"usageCount\": 3,\n        \"createdAt\": \"2023-09-08T10:30:45.123Z\"\n        // ... other fields\n      }\n    ],\n    \"pagination\": {\n      \"page\": 1,\n      \"limit\": 10,\n      \"totalCount\": 25,\n      \"totalPages\": 3,\n      \"hasNext\": true,\n      \"hasPrev\": false\n    },\n    \"statistics\": {\n      \"totalFiles\": 25,\n      \"totalSize\": 15728640,\n      \"imageCount\": 20,\n      \"videoCount\": 5,\n      \"totalUsage\": 47,\n      \"avgFileSize\": 629145.6\n    },\n    \"filters\": {\n      \"type\": \"image\",\n      \"search\": \"advertisement\",\n      \"sort\": \"size\",\n      \"order\": \"desc\"\n    }\n  }\n}\n```\n\n---\n\n## 3. Update Media Metadata\n\n**Endpoint:** `PUT /api/media/:id`\n\n**Description:** Update metadata for existing media. Only the owner can update their media.\n\n### Request Body\n\n```json\n{\n  \"duration\": 20,\n  \"tags\": \"updated,modified,advertisement\",\n  \"description\": \"Updated description for the advertisement\"\n}\n```\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Media updated successfully\",\n  \"data\": {\n    \"_id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n    \"duration\": 20,\n    \"tags\": [\"updated\", \"modified\", \"advertisement\"],\n    \"description\": \"Updated description for the advertisement\",\n    \"updatedAt\": \"2023-09-08T11:15:30.456Z\"\n    // ... other fields\n  }\n}\n```\n\n---\n\n## 4. Delete Media\n\n**Endpoint:** `DELETE /api/media/:id`\n\n**Description:** Delete media from both database and Cloudinary. Implements proper cleanup procedures.\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Media deleted successfully\",\n  \"data\": {\n    \"id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n    \"cloudinaryId\": \"advertisements/64f8a1b2c3d4e5f6a7b8c9d0/images/1694123456789_advertisement\"\n  }\n}\n```\n\n### Error Response (Partial Cleanup)\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Media marked as deleted (cleanup may be needed)\",\n  \"data\": {\n    \"id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n    \"cloudinaryId\": \"advertisements/64f8a1b2c3d4e5f6a7b8c9d0/images/1694123456789_advertisement\"\n  },\n  \"warning\": \"Cloud storage cleanup may be required\"\n}\n```\n\n---\n\n## 5. Generate Secure Download URL\n\n**Endpoint:** `GET /api/media/:id/download`\n\n**Description:** Generate a time-limited, secure download URL for media files. Increments usage counter.\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Download URL generated successfully\",\n  \"data\": {\n    \"downloadUrl\": \"https://res.cloudinary.com/...?sign=...\",\n    \"expiresAt\": \"2023-09-08T12:30:45.123Z\",\n    \"filename\": \"advertisement.jpg\",\n    \"fileSize\": 245760,\n    \"type\": \"image\"\n  }\n}\n```\n\n**Note:** Download URLs expire after 1 hour for security.\n\n---\n\n## 6. Get Media Statistics\n\n**Endpoint:** `GET /api/media/stats`\n\n**Description:** Get comprehensive analytics and statistics for user's media library.\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Media statistics retrieved successfully\",\n  \"data\": {\n    \"database\": {\n      \"totalFiles\": 25,\n      \"totalSize\": 15728640,\n      \"imageCount\": 20,\n      \"videoCount\": 5,\n      \"totalUsage\": 47,\n      \"avgFileSize\": 629145.6\n    },\n    \"recent\": [\n      {\n        \"_id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n        \"originalName\": \"latest-ad.jpg\",\n        \"type\": \"image\",\n        \"createdAt\": \"2023-09-08T10:30:45.123Z\"\n      }\n    ],\n    \"popular\": [\n      {\n        \"_id\": \"64f8a1b2c3d4e5f6a7b8c9d1\",\n        \"originalName\": \"popular-video.mp4\",\n        \"type\": \"video\",\n        \"usageCount\": 15\n      }\n    ],\n    \"storage\": {\n      \"userId\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n      \"images\": {\n        \"count\": 20,\n        \"bytes\": 12582912,\n        \"credits\": 125\n      },\n      \"videos\": {\n        \"count\": 5,\n        \"bytes\": 3145728,\n        \"credits\": 31\n      },\n      \"total\": {\n        \"count\": 25,\n        \"bytes\": 15728640,\n        \"credits\": 156\n      }\n    },\n    \"limits\": {\n      \"maxFileSize\": {\n        \"image\": 10485760,\n        \"video\": 52428800\n      },\n      \"maxFiles\": 1000\n    }\n  }\n}\n```\n\n---\n\n## 7. Generate Video Thumbnail\n\n**Endpoint:** `POST /api/media/:id/thumbnail`\n\n**Description:** Generate a custom thumbnail for video files.\n\n### Request Body\n\n```json\n{\n  \"width\": 400,\n  \"height\": 300,\n  \"start_offset\": \"10\"\n}\n```\n\n### Response\n\n```json\n{\n  \"success\": true,\n  \"message\": \"Thumbnail generated successfully\",\n  \"data\": {\n    \"thumbnailUrl\": \"https://res.cloudinary.com/.../video_thumbnail.jpg\",\n    \"publicId\": \"advertisements/user/videos/video_id\",\n    \"format\": \"jpg\",\n    \"width\": 400,\n    \"height\": 300,\n    \"mediaId\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n    \"originalVideo\": {\n      \"id\": \"64f8a1b2c3d4e5f6a7b8c9d0\",\n      \"originalName\": \"advertisement-video.mp4\",\n      \"cloudinaryId\": \"advertisements/user/videos/video_id\"\n    }\n  }\n}\n```\n\n---\n\n## Error Responses\n\n### Validation Error\n\n```json\n{\n  \"success\": false,\n  \"message\": \"Validation error\",\n  \"errors\": [\n    \"Duration must be between 1 and 300 seconds\",\n    \"Description cannot exceed 500 characters\"\n  ]\n}\n```\n\n### Authentication Error\n\n```json\n{\n  \"success\": false,\n  \"message\": \"Authentication required\"\n}\n```\n\n### Not Found Error\n\n```json\n{\n  \"success\": false,\n  \"message\": \"Media not found or access denied\"\n}\n```\n\n### File Too Large Error\n\n```json\n{\n  \"success\": false,\n  \"message\": \"File size (15MB) exceeds 10MB limit for image files\"\n}\n```\n\n### Rate Limit Error\n\n```json\n{\n  \"success\": false,\n  \"message\": \"Too many upload requests. Please try again later.\",\n  \"retryAfter\": 900\n}\n```\n\n---\n\n## Testing\n\nRun the comprehensive test suite:\n\n```bash\nnode test-media-comprehensive.js\n```\n\nThis will test all endpoints with proper authentication and error handling.\n\n---\n\n## Security Features\n\n- ✅ JWT authentication on all endpoints\n- ✅ User ownership verification\n- ✅ Input validation with Joi schemas\n- ✅ File type and size validation\n- ✅ Rate limiting on uploads\n- ✅ Time-limited download URLs\n- ✅ Proper error handling without sensitive data exposure\n- ✅ Cleanup procedures for failed operations\n\n## Performance Features\n\n- ✅ Database indexing for common queries\n- ✅ Pagination for large result sets\n- ✅ Parallel database operations\n- ✅ Efficient aggregation pipelines\n- ✅ Cloudinary CDN integration\n- ✅ Optimized image/video delivery\n\n## Integration Features\n\n- ✅ Complete Media model integration\n- ✅ User-specific folder organization\n- ✅ Metadata extraction and storage\n- ✅ Usage tracking and analytics\n- ✅ Comprehensive logging with Winston\n- ✅ Error recovery and cleanup"